<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streford Padel Tournament</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        .tier-elite { background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%); }
        .tier-advanced { background: linear-gradient(135deg, #EA580C 0%, #C2410C 100%); }
        .tier-intermediate-plus { background: linear-gradient(135deg, #CA8A04 0%, #A16207 100%); }
        .tier-intermediate { background: linear-gradient(135deg, #16A34A 0%, #15803D 100%); }
        .tier-beginner-plus { background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%); }
        .tier-beginner { background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%); }
        
        .match-within { 
            border-left: 3px solid #7C3AED;
            background: linear-gradient(to right, rgba(124, 58, 237, 0.02), transparent);
        }
        .match-cross { 
            border-left: 3px solid #16A34A;
            background: linear-gradient(to right, rgba(22, 163, 74, 0.02), transparent);
        }
        
        .tab-active { 
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .tab-inactive { 
            background: transparent;
            color: #6B7280;
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
            height: 40px;
        }
        
        /* Apple-style Match Cards */
        .match-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }
        
        .match-card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
            border-color: rgba(59, 130, 246, 0.2);
        }
        
        .match-card.complete {
            background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
            border-color: rgba(22, 163, 74, 0.2);
        }
        
        .score-input {
            font-size: 1.75rem;
            font-weight: 600;
            text-align: center;
            border: none;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 70px;
            height: 70px;
            color: #1F2937;
        }
        
        .score-input:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }
        
        .score-input::placeholder {
            color: #D1D5DB;
            font-weight: 400;
        }
        
        .score-divider {
            font-size: 2rem;
            font-weight: 300;
            color: #D1D5DB;
        }
        
        .player-badge-enhanced {
            padding: 8px 14px;
            border-radius: 100px;
            font-size: 0.8125rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 140px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .player-badge-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .match-type-badge {
            font-size: 0.6875rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 100px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            backdrop-filter: blur(10px);
        }
        
        .winner-banner {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            border-radius: 14px;
            margin-top: 12px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.3px;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .clear-score-btn {
            background: rgba(239, 68, 68, 0.1);
            color: #DC2626;
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .clear-score-btn:hover {
            background: #FEE2E2;
            transform: scale(1.1) rotate(90deg);
        }
        
        .clear-score-btn:active {
            transform: scale(0.95) rotate(90deg);
        }
        
        .filter-section {
            background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
            border: 1px solid #E5E7EB;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .filter-tag {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 100px;
            padding: 10px 18px;
            font-size: 0.8125rem;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            backdrop-filter: blur(10px);
        }
        
        .filter-tag.selected {
            border-color: #3B82F6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }
        
        .tier-filter-tag.selected {
            color: white;
            transform: translateY(-2px) scale(1.05);
        }
        
        .stats-card {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 20px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }
        
        .metric-value {
            font-size: 2.25rem;
            font-weight: 700;
            line-height: 1;
            background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .metric-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #6B7280;
            margin-top: 8px;
        }
        
        .progress-bar {
            height: 8px;
            background: #E5E7EB;
            border-radius: 100px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3B82F6 0%, #8B5CF6 100%);
            border-radius: 100px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        
        .knockout-bracket {
            display: flex;
            gap: 40px;
            overflow-x: auto;
            padding: 20px 0;
        }
        
        .knockout-round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            min-width: 280px;
        }
        
        .knockout-match {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin: 12px 0;
            border: 2px solid #E5E7EB;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .knockout-match:hover {
            transform: translateX(4px);
            border-color: #3B82F6;
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.15);
        }
        
        .knockout-match.completed {
            background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
            border-color: #10B981;
        }
        
        .knockout-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            margin: 4px 0;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .knockout-player.winner {
            background: #10B981;
            color: white;
            font-weight: 600;
            transform: scale(1.02);
        }
        
        .knockout-player:not(.winner) {
            background: #F3F4F6;
        }
        
        .fade-in {
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .7;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div id="app"></div>

    <script>
        // ===== INITIAL PLAYER DATA =====
        const INITIAL_PLAYERS = [
            { name: "Bilal", tier: "Elite" },
            { name: "Sohaib", tier: "Elite" },
            { name: "Azam", tier: "Advanced" },
            { name: "Abdul", tier: "Advanced" },
            { name: "Asim Din", tier: "Advanced" },
            { name: "Arfat", tier: "Advanced" },
            { name: "Chris P", tier: "Intermediate+" },
            { name: "Zafar", tier: "Intermediate+" },
            { name: "Khal", tier: "Intermediate+" },
            { name: "Jacob", tier: "Intermediate+" },
            { name: "Sach", tier: "Intermediate" },
            { name: "Shoaib", tier: "Intermediate" },
            { name: "Darren", tier: "Intermediate" },
            { name: "Tom B", tier: "Intermediate" },
            { name: "Faizan", tier: "Intermediate" },
            { name: "Tariq", tier: "Intermediate" },
            { name: "Ziad", tier: "Beginner+" },
            { name: "Ben Adamson", tier: "Beginner+" },
            { name: "Ste Cotter", tier: "Beginner+" },
            { name: "Jared", tier: "Beginner+" },
            { name: "Basim", tier: "Beginner" },
            { name: "Mugsy", tier: "Beginner" },
            { name: "Moh", tier: "Beginner" },
            { name: "Amir", tier: "Beginner" }
        ];

        // ===== STATE MANAGEMENT =====
        const state = (() => {
            const STORAGE_KEY = 'padel-tournament-v3';
            const BACKUP_KEY = 'padel-tournament-backups-v3';
            
            // Default tiers
            const defaultTiers = ["Elite", "Advanced", "Intermediate+", "Intermediate", "Beginner+", "Beginner"];
            
            // Initialize with player names
            const initialPlayers = INITIAL_PLAYERS.map((player, index) => ({
                id: index + 1,
                name: player.name,
                tier: player.tier
            }));
            
            const defaultState = {
                players: initialPlayers,
                rounds: generateRounds(initialPlayers),
                scores: {},
                currentTab: 'fixtures',
                filters: {
                    round: 'all',
                    matchType: 'all',
                    tiers: [...defaultTiers]
                },
                tiers: [...defaultTiers],
                knockout: {
                    enabled: false,
                    qualifiers: 8,
                    matches: []
                }
            };

            let data = loadState() || defaultState;

            function loadState() {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (!saved) return null;
                    
                    const parsed = JSON.parse(saved);
                    
                    // If there are no player names, populate with default names
                    if (parsed.players && parsed.players.every(p => !p.name || p.name === '')) {
                        parsed.players = initialPlayers;
                    }
                    
                    return parsed;
                } catch (e) {
                    console.error('Error loading state:', e);
                    return null;
                }
            }

            function saveState() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                } catch (e) {
                    console.error('Error saving state:', e);
                }
            }

            function generateRounds(players) {
                // Comprehensive 13-round tournament structure
                return [
                    // Round 1-4: All within-tier
                    {
                        roundNumber: 1,
                        matches: [
                            { team1: [1, 2], team2: [3, 4], matchType: 'within' },
                            { team1: [5, 6], team2: [7, 8], matchType: 'within' },
                            { team1: [9, 10], team2: [11, 12], matchType: 'within' },
                            { team1: [13, 14], team2: [15, 16], matchType: 'within' },
                            { team1: [17, 18], team2: [19, 20], matchType: 'within' },
                            { team1: [21, 22], team2: [23, 24], matchType: 'within' }
                        ]
                    },
                    {
                        roundNumber: 2,
                        matches: [
                            { team1: [1, 3], team2: [2, 4], matchType: 'within' },
                            { team1: [5, 7], team2: [6, 8], matchType: 'within' },
                            { team1: [9, 11], team2: [10, 12], matchType: 'within' },
                            { team1: [13, 15], team2: [14, 16], matchType: 'within' },
                            { team1: [17, 19], team2: [18, 20], matchType: 'within' },
                            { team1: [21, 23], team2: [22, 24], matchType: 'within' }
                        ]
                    },
                    {
                        roundNumber: 3,
                        matches: [
                            { team1: [1, 4], team2: [2, 3], matchType: 'within' },
                            { team1: [5, 8], team2: [6, 7], matchType: 'within' },
                            { team1: [9, 12], team2: [10, 11], matchType: 'within' },
                            { team1: [13, 16], team2: [14, 15], matchType: 'within' },
                            { team1: [17, 20], team2: [18, 19], matchType: 'within' },
                            { team1: [21, 24], team2: [22, 23], matchType: 'within' }
                        ]
                    },
                    {
                        roundNumber: 4,
                        matches: [
                            { team1: [2, 1], team2: [4, 3], matchType: 'within' },
                            { team1: [6, 5], team2: [8, 7], matchType: 'within' },
                            { team1: [10, 9], team2: [12, 11], matchType: 'within' },
                            { team1: [14, 13], team2: [16, 15], matchType: 'within' },
                            { team1: [18, 17], team2: [20, 19], matchType: 'within' },
                            { team1: [22, 21], team2: [24, 23], matchType: 'within' }
                        ]
                    },
                    // Round 5-9: Cross-tier competition
                    {
                        roundNumber: 5,
                        matches: [
                            { team1: [1, 5], team2: [2, 6], matchType: 'cross' },
                            { team1: [3, 7], team2: [4, 8], matchType: 'cross' },
                            { team1: [9, 13], team2: [10, 14], matchType: 'cross' },
                            { team1: [11, 15], team2: [12, 16], matchType: 'cross' },
                            { team1: [17, 21], team2: [18, 22], matchType: 'cross' },
                            { team1: [19, 23], team2: [20, 24], matchType: 'cross' }
                        ]
                    },
                    {
                        roundNumber: 6,
                        matches: [
                            { team1: [1, 6], team2: [2, 5], matchType: 'cross' },
                            { team1: [3, 8], team2: [4, 7], matchType: 'cross' },
                            { team1: [9, 14], team2: [10, 13], matchType: 'cross' },
                            { team1: [11, 16], team2: [12, 15], matchType: 'cross' },
                            { team1: [17, 22], team2: [18, 21], matchType: 'cross' },
                            { team1: [19, 24], team2: [20, 23], matchType: 'cross' }
                        ]
                    },
                    {
                        roundNumber: 7,
                        matches: [
                            { team1: [1, 7], team2: [2, 8], matchType: 'cross' },
                            { team1: [3, 5], team2: [4, 6], matchType: 'cross' },
                            { team1: [9, 15], team2: [10, 16], matchType: 'cross' },
                            { team1: [11, 13], team2: [12, 14], matchType: 'cross' },
                            { team1: [17, 23], team2: [18, 24], matchType: 'cross' },
                            { team1: [19, 21], team2: [20, 22], matchType: 'cross' }
                        ]
                    },
                    {
                        roundNumber: 8,
                        matches: [
                            { team1: [1, 8], team2: [2, 7], matchType: 'cross' },
                            { team1: [3, 6], team2: [4, 5], matchType: 'cross' },
                            { team1: [9, 16], team2: [10, 15], matchType: 'cross' },
                            { team1: [11, 14], team2: [12, 13], matchType: 'cross' },
                            { team1: [17, 24], team2: [18, 23], matchType: 'cross' },
                            { team1: [19, 22], team2: [20, 21], matchType: 'cross' }
                        ]
                    },
                    {
                        roundNumber: 9,
                        matches: [
                            { team1: [2, 6], team2: [1, 5], matchType: 'cross' },
                            { team1: [4, 8], team2: [3, 7], matchType: 'cross' },
                            { team1: [10, 14], team2: [9, 13], matchType: 'cross' },
                            { team1: [12, 16], team2: [11, 15], matchType: 'cross' },
                            { team1: [18, 22], team2: [17, 21], matchType: 'cross' },
                            { team1: [20, 24], team2: [19, 23], matchType: 'cross' }
                        ]
                    },
                    // Round 10-13: Mixed partnerships
                    {
                        roundNumber: 10,
                        matches: [
                            { team1: [1, 9], team2: [2, 10], matchType: 'cross' },
                            { team1: [3, 11], team2: [4, 12], matchType: 'cross' },
                            { team1: [5, 13], team2: [6, 14], matchType: 'cross' },
                            { team1: [7, 15], team2: [8, 16], matchType: 'cross' },
                            { team1: [17, 21], team2: [18, 22], matchType: 'within' },
                            { team1: [19, 23], team2: [20, 24], matchType: 'within' }
                        ]
                    },
                    {
                        roundNumber: 11,
                        matches: [
                            { team1: [1, 10], team2: [2, 9], matchType: 'cross' },
                            { team1: [3, 12], team2: [4, 11], matchType: 'cross' },
                            { team1: [5, 14], team2: [6, 13], matchType: 'cross' },
                            { team1: [7, 16], team2: [8, 15], matchType: 'cross' },
                            { team1: [17, 22], team2: [18, 21], matchType: 'within' },
                            { team1: [19, 24], team2: [20, 23], matchType: 'within' }
                        ]
                    },
                    {
                        roundNumber: 12,
                        matches: [
                            { team1: [1, 11], team2: [2, 12], matchType: 'cross' },
                            { team1: [3, 9], team2: [4, 10], matchType: 'cross' },
                            { team1: [5, 15], team2: [6, 16], matchType: 'cross' },
                            { team1: [7, 13], team2: [8, 14], matchType: 'cross' },
                            { team1: [17, 23], team2: [18, 24], matchType: 'within' },
                            { team1: [19, 21], team2: [20, 22], matchType: 'within' }
                        ]
                    },
                    {
                        roundNumber: 13,
                        matches: [
                            { team1: [1, 12], team2: [2, 11], matchType: 'cross' },
                            { team1: [3, 10], team2: [4, 9], matchType: 'cross' },
                            { team1: [5, 16], team2: [6, 15], matchType: 'cross' },
                            { team1: [7, 14], team2: [8, 13], matchType: 'cross' },
                            { team1: [17, 24], team2: [18, 23], matchType: 'within' },
                            { team1: [19, 22], team2: [20, 21], matchType: 'within' }
                        ]
                    }
                ];
            }

            return {
                get players() { return data.players; },
                get rounds() { return data.rounds; },
                get scores() { return data.scores; },
                get currentTab() { return data.currentTab; },
                set currentTab(tab) { data.currentTab = tab; saveState(); },
                get filters() { return data.filters; },
                get tiers() { return data.tiers; },
                get knockout() { return data.knockout; },
                
                updatePlayerName(id, name) {
                    const player = data.players.find(p => p.id === id);
                    if (player) {
                        player.name = name;
                        saveState();
                    }
                },
                
                updatePlayerTier(id, tier) {
                    const player = data.players.find(p => p.id === id);
                    if (player) {
                        player.tier = tier;
                        saveState();
                    }
                },
                
                updateScore(roundNum, matchIdx, team, score) {
                    const key = `${roundNum}-${matchIdx}`;
                    if (!data.scores[key]) {
                        data.scores[key] = { team1: null, team2: null };
                    }
                    data.scores[key][team] = score === '' ? null : parseInt(score);
                    saveState();
                },
                
                clearScore(roundNum, matchIdx) {
                    const key = `${roundNum}-${matchIdx}`;
                    delete data.scores[key];
                    saveState();
                },
                
                getScore(roundNum, matchIdx) {
                    const key = `${roundNum}-${matchIdx}`;
                    return data.scores[key] || { team1: null, team2: null };
                },
                
                setFilter(type, value) {
                    if (type === 'round' || type === 'matchType') {
                        data.filters[type] = value;
                    } else if (type === 'tier') {
                        const idx = data.filters.tiers.indexOf(value);
                        if (idx > -1) {
                            data.filters.tiers.splice(idx, 1);
                        } else {
                            data.filters.tiers.push(value);
                        }
                    }
                    saveState();
                },
                
                resetAllScores() {
                    this.createBackup('Before Reset');
                    data.scores = {};
                    saveState();
                },
                
                exportData() {
                    return JSON.stringify(data, null, 2);
                },
                
                importData(jsonData) {
                    try {
                        const imported = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
                        data = { ...data, ...imported };
                        saveState();
                    } catch (e) {
                        console.error('Import error:', e);
                    }
                },
                
                createBackup(name) {
                    try {
                        const backups = JSON.parse(localStorage.getItem(BACKUP_KEY) || '[]');
                        backups.push({
                            id: Date.now(),
                            name: name || `Backup ${new Date().toLocaleString()}`,
                            timestamp: new Date().toISOString(),
                            data: JSON.parse(JSON.stringify(data))
                        });
                        if (backups.length > 10) backups.shift();
                        localStorage.setItem(BACKUP_KEY, JSON.stringify(backups));
                    } catch (e) {
                        console.error('Backup error:', e);
                    }
                },
                
                getBackups() {
                    try {
                        return JSON.parse(localStorage.getItem(BACKUP_KEY) || '[]');
                    } catch (e) {
                        return [];
                    }
                },
                
                loadVersion(versionId) {
                    try {
                        const backups = this.getBackups();
                        const backup = backups.find(b => b.id === versionId);
                        if (backup) {
                            this.createBackup('Before Loading Version');
                            data = JSON.parse(JSON.stringify(backup.data));
                            saveState();
                        }
                    } catch (e) {
                        console.error('Load version error:', e);
                    }
                },
                
                deleteVersion(versionId) {
                    try {
                        let backups = this.getBackups();
                        backups = backups.filter(b => b.id !== versionId);
                        localStorage.setItem(BACKUP_KEY, JSON.stringify(backups));
                    } catch (e) {
                        console.error('Delete version error:', e);
                    }
                },
                
                toggleKnockout(enabled) {
                    data.knockout.enabled = enabled;
                    if (enabled) {
                        this.generateKnockoutBracket();
                    }
                    saveState();
                },
                
                setKnockoutQualifiers(num) {
                    data.knockout.qualifiers = num;
                    if (data.knockout.enabled) {
                        this.generateKnockoutBracket();
                    }
                    saveState();
                },
                
                generateKnockoutBracket() {
                    const results = this.calculateResults();
                    const topPlayers = results.slice(0, data.knockout.qualifiers);
                    
                    const matches = [];
                    const numRounds = Math.log2(data.knockout.qualifiers);
                    
                    for (let round = 0; round < numRounds; round++) {
                        const matchesInRound = data.knockout.qualifiers / Math.pow(2, round + 1);
                        for (let i = 0; i < matchesInRound; i++) {
                            matches.push({
                                round: round + 1,
                                matchNumber: i + 1,
                                player1: round === 0 ? topPlayers[i * 2] : null,
                                player2: round === 0 ? topPlayers[i * 2 + 1] : null,
                                winner: null,
                                score1: null,
                                score2: null
                            });
                        }
                    }
                    
                    data.knockout.matches = matches;
                    saveState();
                },
                
                updateKnockoutScore(round, matchNumber, score1, score2) {
                    const match = data.knockout.matches.find(
                        m => m.round === round && m.matchNumber === matchNumber
                    );
                    
                    if (match) {
                        match.score1 = score1;
                        match.score2 = score2;
                        
                        if (score1 !== null && score2 !== null) {
                            match.winner = score1 > score2 ? match.player1 : match.player2;
                            
                            const nextRound = round + 1;
                            const nextMatchNumber = Math.ceil(matchNumber / 2);
                            const nextMatch = data.knockout.matches.find(
                                m => m.round === nextRound && m.matchNumber === nextMatchNumber
                            );
                            
                            if (nextMatch) {
                                if (matchNumber % 2 === 1) {
                                    nextMatch.player1 = match.winner;
                                } else {
                                    nextMatch.player2 = match.winner;
                                }
                            }
                        }
                        
                        saveState();
                    }
                },
                
                calculateResults() {
                    const playerStats = {};
                    
                    data.players.forEach(player => {
                        playerStats[player.id] = {
                            id: player.id,
                            name: player.name,
                            tier: player.tier,
                            played: 0,
                            won: 0,
                            lost: 0,
                            pointsFor: 0,
                            pointsAgainst: 0,
                            pointsDiff: 0,
                            winRate: 0
                        };
                    });
                    
                    data.rounds.forEach(round => {
                        round.matches.forEach((match, idx) => {
                            const score = this.getScore(round.roundNumber, idx);
                            if (score.team1 !== null && score.team2 !== null) {
                                const [p1, p2] = match.team1;
                                const [p3, p4] = match.team2;
                                
                                [p1, p2, p3, p4].forEach(pid => {
                                    playerStats[pid].played++;
                                });
                                
                                if (score.team1 > score.team2) {
                                    playerStats[p1].won++;
                                    playerStats[p2].won++;
                                    playerStats[p3].lost++;
                                    playerStats[p4].lost++;
                                } else {
                                    playerStats[p3].won++;
                                    playerStats[p4].won++;
                                    playerStats[p1].lost++;
                                    playerStats[p2].lost++;
                                }
                                
                                playerStats[p1].pointsFor += score.team1;
                                playerStats[p2].pointsFor += score.team1;
                                playerStats[p1].pointsAgainst += score.team2;
                                playerStats[p2].pointsAgainst += score.team2;
                                
                                playerStats[p3].pointsFor += score.team2;
                                playerStats[p4].pointsFor += score.team2;
                                playerStats[p3].pointsAgainst += score.team1;
                                playerStats[p4].pointsAgainst += score.team1;
                            }
                        });
                    });
                    
                    Object.values(playerStats).forEach(stats => {
                        stats.pointsDiff = stats.pointsFor - stats.pointsAgainst;
                        stats.winRate = stats.played > 0 ? (stats.won / stats.played * 100) : 0;
                    });
                    
                    return Object.values(playerStats).sort((a, b) => {
                        if (b.won !== a.won) return b.won - a.won;
                        if (b.pointsDiff !== a.pointsDiff) return b.pointsDiff - a.pointsDiff;
                        return b.pointsFor - a.pointsFor;
                    });
                }
            };
        })();

        // ===== HELPER FUNCTIONS =====
        function getPlayerName(id) {
            const player = state.players.find(p => p.id === id);
            return player?.name || `Player ${id}`;
        }

        function getPlayerTier(id) {
            const player = state.players.find(p => p.id === id);
            return player?.tier || 'Unknown';
        }

        function getTierClass(tier) {
            const map = {
                'Elite': 'tier-elite',
                'Advanced': 'tier-advanced',
                'Intermediate+': 'tier-intermediate-plus',
                'Intermediate': 'tier-intermediate',
                'Beginner+': 'tier-beginner-plus',
                'Beginner': 'tier-beginner'
            };
            return map[tier] || 'tier-intermediate';
        }

        function getMatchTypeLabel(type) {
            return type === 'within' ? 'Within Tier' : 'Cross Tier';
        }

        function getMatchTypeClass(type) {
            return type === 'within' ? 'match-within' : 'match-cross';
        }

        // ===== COMPONENTS =====
        function PlayerBadge(playerId) {
            const name = getPlayerName(playerId);
            const tier = getPlayerTier(playerId);
            const tierClass = getTierClass(tier);
            
            return `
                <div class="player-badge-enhanced ${tierClass} text-white">
                    ${name}
                </div>
            `;
        }

        function MatchCard(match, roundNum, matchIdx) {
            const score = state.getScore(roundNum, matchIdx);
            const isComplete = score.team1 !== null && score.team2 !== null;
            const winner = isComplete && score.team1 !== score.team2 
                ? (score.team1 > score.team2 ? 'team1' : 'team2') 
                : null;
            
            return `
                <div class="match-card ${isComplete ? 'complete' : ''} fade-in">
                    <div class="p-6">
                        <!-- Match Header -->
                        <div class="flex items-center justify-between mb-6">
                            <div class="match-type-badge ${getMatchTypeClass(match.matchType)} ${match.matchType === 'within' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}">
                                ${getMatchTypeLabel(match.matchType)}
                            </div>
                        </div>
                        
                        <!-- Team 1 -->
                        <div class="mb-4 ${winner === 'team1' ? 'opacity-100' : winner ? 'opacity-60' : ''}">
                            <div class="flex flex-wrap gap-2 mb-3">
                                ${PlayerBadge(match.team1[0])}
                                ${PlayerBadge(match.team1[1])}
                            </div>
                        </div>
                        
                        <!-- Score Input -->
                        <div class="flex items-center justify-center gap-4 my-6">
                            <input 
                                type="number" 
                                class="score-input" 
                                placeholder="0"
                                min="0"
                                value="${score.team1 !== null ? score.team1 : ''}"
                                onchange="state.updateScore(${roundNum}, ${matchIdx}, 'team1', this.value); render();"
                            >
                            <div class="score-divider">:</div>
                            <input 
                                type="number" 
                                class="score-input" 
                                placeholder="0"
                                min="0"
                                value="${score.team2 !== null ? score.team2 : ''}"
                                onchange="state.updateScore(${roundNum}, ${matchIdx}, 'team2', this.value); render();"
                            >
                        </div>
                        
                        <!-- Team 2 -->
                        <div class="mb-4 ${winner === 'team2' ? 'opacity-100' : winner ? 'opacity-60' : ''}">
                            <div class="flex flex-wrap gap-2">
                                ${PlayerBadge(match.team2[0])}
                                ${PlayerBadge(match.team2[1])}
                            </div>
                        </div>
                        
                        <!-- Winner Banner -->
                        ${isComplete && winner ? `
                            <div class="winner-banner">
                                üèÜ ${getPlayerName(match[winner][0])} & ${getPlayerName(match[winner][1])} Win!
                            </div>
                        ` : ''}
                        
                        <!-- Clear Button -->
                        ${isComplete ? `
                            <div class="flex justify-center mt-4">
                                <button 
                                    class="clear-score-btn"
                                    onclick="state.clearScore(${roundNum}, ${matchIdx}); render();"
                                    title="Clear score"
                                >
                                    √ó
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function TournamentFixturesTab() {
            const filteredRounds = state.rounds.filter(round => {
                if (state.filters.round !== 'all' && round.roundNumber !== parseInt(state.filters.round)) {
                    return false;
                }
                return true;
            }).map(round => {
                const filteredMatches = round.matches.filter(match => {
                    if (state.filters.matchType !== 'all' && match.matchType !== state.filters.matchType) {
                        return false;
                    }
                    
                    const playerIds = [...match.team1, ...match.team2];
                    const playerTiers = playerIds.map(id => getPlayerTier(id));
                    const hasSelectedTier = playerTiers.some(tier => state.filters.tiers.includes(tier));
                    
                    return hasSelectedTier;
                });
                
                return { ...round, matches: filteredMatches };
            }).filter(round => round.matches.length > 0);
            
            const totalMatches = filteredRounds.reduce((sum, r) => sum + r.matches.length, 0);
            const completedMatches = filteredRounds.reduce((sum, r) => {
                return sum + r.matches.filter((m, idx) => {
                    const score = state.getScore(r.roundNumber, idx);
                    return score.team1 !== null && score.team2 !== null;
                }).length;
            }, 0);
            
            return `
                <div>
                    <!-- Filters -->
                    <div class="filter-section">
                        <div class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide">Filters</div>
                        
                        <!-- Round Filter -->
                        <div class="mb-4">
                            <div class="text-xs font-semibold text-gray-600 mb-2 uppercase">Round</div>
                            <div class="flex flex-wrap gap-2">
                                <button 
                                    onclick="state.setFilter('round', 'all'); render();"
                                    class="filter-tag ${state.filters.round === 'all' ? 'selected bg-blue-100 text-blue-700' : 'bg-white text-gray-700'}"
                                >
                                    All Rounds
                                </button>
                                ${state.rounds.map(r => `
                                    <button 
                                        onclick="state.setFilter('round', ${r.roundNumber}); render();"
                                        class="filter-tag ${state.filters.round === r.roundNumber ? 'selected bg-blue-100 text-blue-700' : 'bg-white text-gray-700'}"
                                    >
                                        Round ${r.roundNumber}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Match Type Filter -->
                        <div class="mb-4">
                            <div class="text-xs font-semibold text-gray-600 mb-2 uppercase">Match Type</div>
                            <div class="flex flex-wrap gap-2">
                                <button 
                                    onclick="state.setFilter('matchType', 'all'); render();"
                                    class="filter-tag ${state.filters.matchType === 'all' ? 'selected bg-blue-100 text-blue-700' : 'bg-white text-gray-700'}"
                                >
                                    All Types
                                </button>
                                <button 
                                    onclick="state.setFilter('matchType', 'within'); render();"
                                    class="filter-tag ${state.filters.matchType === 'within' ? 'selected bg-purple-100 text-purple-700' : 'bg-white text-gray-700'}"
                                >
                                    Within Tier
                                </button>
                                <button 
                                    onclick="state.setFilter('matchType', 'cross'); render();"
                                    class="filter-tag ${state.filters.matchType === 'cross' ? 'selected bg-green-100 text-green-700' : 'bg-white text-gray-700'}"
                                >
                                    Cross Tier
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tier Filter -->
                        <div>
                            <div class="text-xs font-semibold text-gray-600 mb-2 uppercase">Skill Tiers</div>
                            <div class="flex flex-wrap gap-2">
                                ${state.tiers.map(tier => `
                                    <button 
                                        onclick="state.setFilter('tier', '${tier}'); render();"
                                        class="filter-tag tier-filter-tag ${getTierClass(tier)} ${state.filters.tiers.includes(tier) ? 'selected' : 'opacity-40'} text-white"
                                    >
                                        ${tier}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6 border border-gray-100">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-sm font-semibold text-gray-700">Tournament Progress</span>
                            <span class="text-sm font-bold text-blue-600">${completedMatches}/${totalMatches} matches</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${totalMatches > 0 ? (completedMatches / totalMatches * 100) : 0}%"></div>
                        </div>
                    </div>
                    
                    <!-- Rounds -->
                    ${filteredRounds.map(round => `
                        <div class="mb-8">
                            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-2xl p-5 mb-4 shadow-lg">
                                <div class="flex items-center justify-between">
                                    <h2 class="text-2xl font-bold">Round ${round.roundNumber}</h2>
                                    <div class="text-sm font-medium bg-white/20 backdrop-blur rounded-full px-4 py-2">
                                        ${round.matches.length} matches
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${round.matches.map((match, idx) => MatchCard(match, round.roundNumber, idx)).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function PlayersTab() {
            return `
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Player Management</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${state.players.map(player => `
                            <div class="bg-gradient-to-br from-gray-50 to-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-all">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="text-2xl font-bold text-gray-400">${player.id}</div>
                                    <input 
                                        type="text" 
                                        value="${player.name}"
                                        placeholder="Player Name"
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        onchange="state.updatePlayerName(${player.id}, this.value); render();"
                                    >
                                </div>
                                <select 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    onchange="state.updatePlayerTier(${player.id}, this.value); render();"
                                >
                                    ${state.tiers.map(tier => `
                                        <option value="${tier}" ${player.tier === tier ? 'selected' : ''}>${tier}</option>
                                    `).join('')}
                                </select>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function DataManagementTab() {
            const backups = state.getBackups();
            
            return `
                <div class="space-y-6">
                    <!-- Quick Actions -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Quick Actions</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button 
                                onclick="exportData();"
                                class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1"
                            >
                                üì• Export Data
                            </button>
                            <label class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-4 rounded-xl font-semibold hover:from-green-700 hover:to-green-800 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1 cursor-pointer text-center">
                                üì§ Import Data
                                <input type="file" accept=".json" class="hidden" onchange="importData(this.files[0]);">
                            </label>
                            <button 
                                onclick="resetScores();"
                                class="bg-gradient-to-r from-red-600 to-red-700 text-white px-6 py-4 rounded-xl font-semibold hover:from-red-700 hover:to-red-800 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1"
                            >
                                üîÑ Reset Scores
                            </button>
                        </div>
                    </div>
                    
                    <!-- Version Control -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Version Control</h2>
                        
                        <div class="flex gap-3 mb-6">
                            <input 
                                type="text" 
                                id="backup-name" 
                                placeholder="Version name (optional)"
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                            <button 
                                onclick="saveBackup();"
                                class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-6 py-3 rounded-xl font-semibold hover:from-purple-700 hover:to-purple-800 transition-all shadow-lg"
                            >
                                üíæ Save Version
                            </button>
                        </div>
                        
                        ${backups.length > 0 ? `
                            <div class="space-y-3">
                                ${backups.map(backup => `
                                    <div class="flex items-center justify-between bg-gradient-to-r from-gray-50 to-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-all">
                                        <div>
                                            <div class="font-semibold text-gray-900">${backup.name}</div>
                                            <div class="text-sm text-gray-500">${new Date(backup.timestamp).toLocaleString()}</div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button 
                                                onclick="loadVersion(${backup.id});"
                                                class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-medium hover:bg-blue-200 transition-colors"
                                            >
                                                Load
                                            </button>
                                            <button 
                                                onclick="deleteVersion(${backup.id});"
                                                class="px-4 py-2 bg-red-100 text-red-700 rounded-lg font-medium hover:bg-red-200 transition-colors"
                                            >
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-8 text-gray-500">
                                No saved versions yet. Click "Save Version" to create one!
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function ResultsTab() {
            const results = state.calculateResults();
            
            return `
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                        <h2 class="text-2xl font-bold">Tournament Results</h2>
                        <div class="text-sm opacity-90 mt-1">Live standings and statistics</div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Rank</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Player</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tier</th>
                                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Played</th>
                                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Won</th>
                                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Lost</th>
                                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Win %</th>
                                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Points For</th>
                                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Points Against</th>
                                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Diff</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${results.map((player, index) => `
                                    <tr class="hover:bg-gray-50 transition-colors ${index < 3 ? 'bg-gradient-to-r from-yellow-50 to-transparent' : ''}">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-lg font-bold ${index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-orange-600' : 'text-gray-600'}">
                                                ${index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : index + 1}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="font-semibold text-gray-900">${player.name}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="${getTierClass(player.tier)} text-white text-xs font-semibold px-3 py-1 rounded-full">
                                                ${player.tier}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-gray-700">${player.played}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center font-semibold text-green-600">${player.won}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center font-semibold text-red-600">${player.lost}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center font-semibold text-blue-600">${player.winRate.toFixed(1)}%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-gray-700">${player.pointsFor}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-gray-700">${player.pointsAgainst}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center font-semibold ${player.pointsDiff >= 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${player.pointsDiff >= 0 ? '+' : ''}${player.pointsDiff}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function FairnessTab() {
            const analysis = analyzePartnerFairness();
            
            return `
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Partnership Fairness Analysis</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="stats-card">
                                <div class="metric-value">${analysis.totalPairs}</div>
                                <div class="metric-label">Total Partnerships</div>
                            </div>
                            <div class="stats-card">
                                <div class="metric-value">${analysis.avgPartnerships.toFixed(1)}</div>
                                <div class="metric-label">Avg per Player</div>
                            </div>
                            <div class="stats-card">
                                <div class="metric-value">${analysis.uniquePartnerships}</div>
                                <div class="metric-label">Unique Pairs</div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Player</th>
                                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Partnerships</th>
                                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Unique Partners</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Most Frequent</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${analysis.playerData.map(data => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 font-semibold text-gray-900">${data.name}</td>
                                            <td class="px-4 py-3 text-center text-gray-700">${data.totalPartnerships}</td>
                                            <td class="px-4 py-3 text-center text-gray-700">${data.uniquePartners}</td>
                                            <td class="px-4 py-3">
                                                ${data.mostFrequent ? `
                                                    <span class="text-sm text-gray-700">
                                                        ${data.mostFrequent.name} (${data.mostFrequent.count}√ó)
                                                    </span>
                                                ` : '-'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function analyzePartnerFairness() {
            const partnerships = {};
            const playerPartners = {};
            
            state.players.forEach(player => {
                playerPartners[player.id] = {};
            });
            
            state.rounds.forEach(round => {
                round.matches.forEach(match => {
                    const pairs = [
                        [match.team1[0], match.team1[1]],
                        [match.team2[0], match.team2[1]]
                    ];
                    
                    pairs.forEach(([p1, p2]) => {
                        const key = [p1, p2].sort().join('-');
                        partnerships[key] = (partnerships[key] || 0) + 1;
                        
                        playerPartners[p1][p2] = (playerPartners[p1][p2] || 0) + 1;
                        playerPartners[p2][p1] = (playerPartners[p2][p1] || 0) + 1;
                    });
                });
            });
            
            const playerData = state.players.map(player => {
                const partners = playerPartners[player.id];
                const entries = Object.entries(partners);
                const mostFrequent = entries.length > 0 
                    ? entries.reduce((max, [partnerId, count]) => 
                        count > max.count ? { partnerId, count } : max, 
                        { partnerId: null, count: 0 })
                    : null;
                
                return {
                    name: player.name,
                    totalPartnerships: Object.values(partners).reduce((sum, count) => sum + count, 0),
                    uniquePartners: entries.length,
                    mostFrequent: mostFrequent && mostFrequent.partnerId 
                        ? { name: getPlayerName(parseInt(mostFrequent.partnerId)), count: mostFrequent.count }
                        : null
                };
            });
            
            return {
                totalPairs: Object.keys(partnerships).length,
                uniquePartnerships: Object.keys(partnerships).length,
                avgPartnerships: playerData.reduce((sum, p) => sum + p.totalPartnerships, 0) / playerData.length,
                playerData
            };
        }

        function Fairness2Tab() {
            const analysis = analyzeOpponentFairness();
            
            return `
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Opponent Fairness Analysis</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="stats-card">
                                <div class="metric-value">${analysis.totalMatchups}</div>
                                <div class="metric-label">Total Matchups</div>
                            </div>
                            <div class="stats-card">
                                <div class="metric-value">${analysis.avgOpponents.toFixed(1)}</div>
                                <div class="metric-label">Avg Opponents</div>
                            </div>
                            <div class="stats-card">
                                <div class="metric-value">${analysis.uniqueMatchups}</div>
                                <div class="metric-label">Unique Matchups</div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Player</th>
                                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Total Matches</th>
                                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Unique Opponents</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Most Faced</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${analysis.playerData.map(data => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 font-semibold text-gray-900">${data.name}</td>
                                            <td class="px-4 py-3 text-center text-gray-700">${data.totalMatches}</td>
                                            <td class="px-4 py-3 text-center text-gray-700">${data.uniqueOpponents}</td>
                                            <td class="px-4 py-3">
                                                ${data.mostFaced ? `
                                                    <span class="text-sm text-gray-700">
                                                        ${data.mostFaced.name} (${data.mostFaced.count}√ó)
                                                    </span>
                                                ` : '-'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function analyzeOpponentFairness() {
            const matchups = {};
            const playerOpponents = {};
            
            state.players.forEach(player => {
                playerOpponents[player.id] = {};
            });
            
            state.rounds.forEach(round => {
                round.matches.forEach(match => {
                    const team1 = match.team1;
                    const team2 = match.team2;
                    
                    team1.forEach(p1 => {
                        team2.forEach(p2 => {
                            playerOpponents[p1][p2] = (playerOpponents[p1][p2] || 0) + 1;
                            playerOpponents[p2][p1] = (playerOpponents[p2][p1] || 0) + 1;
                        });
                    });
                });
            });
            
            const playerData = state.players.map(player => {
                const opponents = playerOpponents[player.id];
                const entries = Object.entries(opponents);
                const mostFaced = entries.length > 0 
                    ? entries.reduce((max, [opponentId, count]) => 
                        count > max.count ? { opponentId, count } : max, 
                        { opponentId: null, count: 0 })
                    : null;
                
                return {
                    name: player.name,
                    totalMatches: Object.values(opponents).reduce((sum, count) => sum + count, 0),
                    uniqueOpponents: entries.length,
                    mostFaced: mostFaced && mostFaced.opponentId 
                        ? { name: getPlayerName(parseInt(mostFaced.opponentId)), count: mostFaced.count }
                        : null
                };
            });
            
            let totalMatchups = 0;
            Object.values(playerOpponents).forEach(opponents => {
                totalMatchups += Object.keys(opponents).length;
            });
            
            return {
                totalMatchups: totalMatchups / 2,
                uniqueMatchups: totalMatchups / 2,
                avgOpponents: playerData.reduce((sum, p) => sum + p.uniqueOpponents, 0) / playerData.length,
                playerData
            };
        }

        function PartnershipsTab() {
            const partnerships = {};
            
            state.rounds.forEach(round => {
                round.matches.forEach(match => {
                    const pairs = [
                        [match.team1[0], match.team1[1]],
                        [match.team2[0], match.team2[1]]
                    ];
                    
                    pairs.forEach(([p1, p2]) => {
                        const key = [p1, p2].sort().join('-');
                        if (!partnerships[key]) {
                            partnerships[key] = {
                                players: [p1, p2],
                                count: 0,
                                rounds: []
                            };
                        }
                        partnerships[key].count++;
                        partnerships[key].rounds.push(round.roundNumber);
                    });
                });
            });
            
            const sortedPartnerships = Object.values(partnerships)
                .sort((a, b) => b.count - a.count);
            
            return `
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">All Partnerships</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${sortedPartnerships.map(partnership => `
                            <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-4 border border-gray-200">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-2xl font-bold text-blue-600">${partnership.count}√ó</div>
                                    <div class="text-xs text-gray-500">matches</div>
                                </div>
                                <div class="space-y-1 mb-2">
                                    <div class="font-semibold text-gray-900">${getPlayerName(partnership.players[0])}</div>
                                    <div class="font-semibold text-gray-900">${getPlayerName(partnership.players[1])}</div>
                                </div>
                                <div class="text-xs text-gray-600">
                                    Rounds: ${partnership.rounds.join(', ')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function KnockoutTab() {
            const results = state.calculateResults();
            const topPlayers = results.slice(0, 16);
            
            return `
                <div class="space-y-6">
                    <!-- Knockout Configuration -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Knockout Stage</h2>
                        
                        <div class="flex items-center gap-6 mb-6">
                            <label class="flex items-center gap-3">
                                <input 
                                    type="checkbox" 
                                    ${state.knockout.enabled ? 'checked' : ''}
                                    onchange="state.toggleKnockout(this.checked); render();"
                                    class="w-5 h-5 text-blue-600 rounded"
                                >
                                <span class="font-semibold text-gray-700">Enable Knockout Stage</span>
                            </label>
                            
                            ${state.knockout.enabled ? `
                                <select 
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    onchange="state.setKnockoutQualifiers(parseInt(this.value)); render();"
                                >
                                    <option value="4" ${state.knockout.qualifiers === 4 ? 'selected' : ''}>Top 4</option>
                                    <option value="8" ${state.knockout.qualifiers === 8 ? 'selected' : ''}>Top 8</option>
                                    <option value="16" ${state.knockout.qualifiers === 16 ? 'selected' : ''}>Top 16</option>
                                </select>
                            ` : ''}
                        </div>
                        
                        ${!state.knockout.enabled ? `
                            <div class="text-center py-8 text-gray-500">
                                Enable knockout stage to see the bracket
                            </div>
                        ` : ''}
                    </div>
                    
                    ${state.knockout.enabled ? KnockoutBracket() : ''}
                </div>
            `;
        }

        function KnockoutBracket() {
            const rounds = Math.log2(state.knockout.qualifiers);
            const roundNames = ['Semi-Finals', 'Finals'];
            if (state.knockout.qualifiers >= 8) roundNames.unshift('Quarter-Finals');
            if (state.knockout.qualifiers >= 16) roundNames.unshift('Round of 16');
            
            return `
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-900 mb-6">Knockout Bracket</h3>
                    
                    <div class="knockout-bracket">
                        ${Array.from({ length: rounds }, (_, roundIdx) => {
                            const matchesInRound = state.knockout.matches.filter(m => m.round === roundIdx + 1);
                            return `
                                <div class="knockout-round">
                                    <h4 class="text-lg font-bold text-gray-900 mb-4">${roundNames[roundIdx]}</h4>
                                    ${matchesInRound.map(match => KnockoutMatch(match)).join('')}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function KnockoutMatch(match) {
            const isComplete = match.score1 !== null && match.score2 !== null;
            
            return `
                <div class="knockout-match ${isComplete ? 'completed' : ''}">
                    <div class="text-xs font-semibold text-gray-500 mb-3 uppercase">Match ${match.matchNumber}</div>
                    
                    ${match.player1 ? `
                        <div class="knockout-player ${match.winner?.id === match.player1.id ? 'winner' : ''}">
                            <span>${match.player1.name}</span>
                            ${isComplete ? `<span class="font-bold">${match.score1}</span>` : ''}
                        </div>
                    ` : '<div class="knockout-player text-gray-400">TBD</div>'}
                    
                    ${match.player2 ? `
                        <div class="knockout-player ${match.winner?.id === match.player2.id ? 'winner' : ''}">
                            <span>${match.player2.name}</span>
                            ${isComplete ? `<span class="font-bold">${match.score2}</span>` : ''}
                        </div>
                    ` : '<div class="knockout-player text-gray-400">TBD</div>'}
                    
                    ${match.player1 && match.player2 && !isComplete ? `
                        <div class="mt-3 flex gap-2">
                            <input 
                                type="number" 
                                placeholder="0"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-center"
                                value="${match.score1 !== null ? match.score1 : ''}"
                                onchange="state.updateKnockoutScore(${match.round}, ${match.matchNumber}, parseInt(this.value) || 0, ${match.score2 || 0}); render();"
                            >
                            <input 
                                type="number" 
                                placeholder="0"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-center"
                                value="${match.score2 !== null ? match.score2 : ''}"
                                onchange="state.updateKnockoutScore(${match.round}, ${match.matchNumber}, ${match.score1 || 0}, parseInt(this.value) || 0); render();"
                            >
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ===== UTILITY FUNCTIONS =====
        function exportData() {
            const data = state.exportData();
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `padel-tournament-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('Tournament data exported successfully!');
        }

        function importData(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    state.importData(data);
                    render();
                    alert('Tournament data imported successfully!');
                } catch (error) {
                    alert('Error importing data. Please make sure the file is valid.');
                }
            };
            reader.readAsText(file);
        }

        function resetScores() {
            if (confirm('This will clear all match scores. A backup will be created automatically. Continue?')) {
                state.resetAllScores();
                render();
                alert('Backup saved! All scores have been reset!');
            }
        }

        function saveBackup() {
            const nameInput = document.getElementById('backup-name');
            const name = nameInput.value.trim() || `Backup ${new Date().toLocaleString()}`;
            state.createBackup(name);
            nameInput.value = '';
            render();
            alert('Version saved successfully!');
        }

        function loadVersion(versionId) {
            if (confirm('Load this version? Current state will be backed up first.')) {
                state.loadVersion(versionId);
                render();
                alert('Current state backed up! Version loaded successfully!');
            }
        }

        function deleteVersion(versionId) {
            if (confirm('Delete this saved version?')) {
                state.deleteVersion(versionId);
                render();
            }
        }

        // ===== MAIN RENDER =====
        function render() {
            const app = document.getElementById('app');
            
            const tabContent = {
                'fixtures': TournamentFixturesTab(),
                'players': PlayersTab(),
                'data': DataManagementTab(),
                'results': ResultsTab(),
                'fairness': FairnessTab(),
                'fairness2': Fairness2Tab(),
                'partnerships': PartnershipsTab(),
                'knockout': KnockoutTab()
            };
            
            app.innerHTML = `
                <div class="max-w-7xl mx-auto p-4 md:p-6 pb-12">
                    <!-- Header -->
                    <div class="relative bg-white text-gray-900 rounded-3xl shadow-sm p-8 md:p-10 mb-8 overflow-hidden border border-gray-100">
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-50 via-white to-purple-50 opacity-60"></div>
                        <div class="relative">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="text-5xl md:text-6xl">üèì</div>
                                <div>
                                    <h1 class="text-3xl md:text-4xl font-bold mb-1" style="letter-spacing: -1px;">Stretford Padel Tournament</h1>
                                    <div class="text-sm text-gray-500 font-medium">Professional Match Manager</div>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2 text-xs md:text-sm">
                                <div class="flex items-center gap-2 bg-white/80 backdrop-blur rounded-full px-4 py-2 border border-gray-200">
                                    <span class="text-base">üë•</span>
                                    <span class="font-semibold text-gray-700">24 Players</span>
                                </div>
                                <div class="flex items-center gap-2 bg-white/80 backdrop-blur rounded-full px-4 py-2 border border-gray-200">
                                    <span class="text-base">üéØ</span>
                                    <span class="font-semibold text-gray-700">13 Rounds</span>
                                </div>
                                <div class="flex items-center gap-2 bg-white/80 backdrop-blur rounded-full px-4 py-2 border border-gray-200">
                                    <span class="text-base">‚öñÔ∏è</span>
                                    <span class="font-semibold text-gray-700">Optimized</span>
                                </div>
                                <div class="flex items-center gap-2 bg-green-50 backdrop-blur rounded-full px-4 py-2 border border-green-200">
                                    <span class="text-base">üíæ</span>
                                    <span class="font-semibold text-green-700">Auto-saved</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="bg-white rounded-2xl shadow-sm mb-8 overflow-hidden border border-gray-100">
                        <div class="overflow-x-auto">
                            <div class="flex p-2 gap-1 min-w-max">
                                <button 
                                    onclick="state.currentTab = 'fixtures'; render();"
                                    class="px-5 py-3 font-semibold text-sm rounded-xl transition-all ${state.currentTab === 'fixtures' ? 'tab-active' : 'tab-inactive hover:bg-gray-100'}"
                                    style="letter-spacing: -0.2px;"
                                >
                                    Fixtures
                                </button>
                                <button 
                                    onclick="state.currentTab = 'players'; render();"
                                    class="px-5 py-3 font-semibold text-sm rounded-xl transition-all ${state.currentTab === 'players' ? 'tab-active' : 'tab-inactive hover:bg-gray-100'}"
                                    style="letter-spacing: -0.2px;"
                                >
                                    Players
                                </button>
                                <button 
                                    onclick="state.currentTab = 'data'; render();"
                                    class="px-5 py-3 font-semibold text-sm rounded-xl transition-all ${state.currentTab === 'data' ? 'tab-active' : 'tab-inactive hover:bg-gray-100'}"
                                    style="letter-spacing: -0.2px;"
                                >
                                    Data
                                </button>
                                <button 
                                    onclick="state.currentTab = 'results'; render();"
                                    class="px-5 py-3 font-semibold text-sm rounded-xl transition-all ${state.currentTab === 'results' ? 'tab-active' : 'tab-inactive hover:bg-gray-100'}"
                                    style="letter-spacing: -0.2px;"
                                >
                                    Results
                                </button>
                                <button 
                                    onclick="state.currentTab = 'fairness'; render();"
                                    class="px-5 py-3 font-semibold text-sm rounded-xl transition-all ${state.currentTab === 'fairness' ? 'tab-active' : 'tab-inactive hover:bg-gray-100'}"
                                    style="letter-spacing: -0.2px;"
                                >
                                    Fairness
                                </button>
                                <button 
                                    onclick="state.currentTab = 'fairness2'; render();"
                                    class="px-5 py-3 font-semibold text-sm rounded-xl transition-all ${state.currentTab === 'fairness2' ? 'tab-active' : 'tab-inactive hover:bg-gray-100'}"
                                    style="letter-spacing: -0.2px;"
                                >
                                    Fairness 2
                                </button>
                                <button 
                                    onclick="state.currentTab = 'partnerships'; render();"
                                    class="px-5 py-3 font-semibold text-sm rounded-xl transition-all ${state.currentTab === 'partnerships' ? 'tab-active' : 'tab-inactive hover:bg-gray-100'}"
                                    style="letter-spacing: -0.2px;"
                                >
                                    Partners
                                </button>
                                <button 
                                    onclick="state.currentTab = 'knockout'; render();"
                                    class="px-5 py-3 font-semibold text-sm rounded-xl transition-all ${state.currentTab === 'knockout' ? 'tab-active' : 'tab-inactive hover:bg-gray-100'}"
                                    style="letter-spacing: -0.2px;"
                                >
                                    Knockout
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Content -->
                    <div>
                        ${tabContent[state.currentTab]}
                    </div>
                </div>
            `;
        }

        // Initial render
        render();
    </script>
</body>
</html>
